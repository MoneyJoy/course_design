# -*- coding: utf-8 -*-
"""
MQTTç‰©è”ç½‘ç½‘å…³æœåŠ¡
====================

è¿™æ˜¯ä¸€ä¸ªåŸºäºPythonçš„MQTTç½‘å…³æœåŠ¡ï¼Œä¸»è¦åŠŸèƒ½åŒ…æ‹¬ï¼š
1. è¿æ¥MQTTä»£ç†æœåŠ¡å™¨ï¼ˆå¦‚EMQXï¼‰
2. è®¢é˜…è®¾å¤‡æ•°æ®ä¸»é¢˜ï¼Œæ¥æ”¶æ¥è‡ªSTM32ç­‰è®¾å¤‡çš„ä¼ æ„Ÿå™¨æ•°æ®
3. å°†æ¥æ”¶åˆ°çš„æ•°æ®å­˜å‚¨åˆ°MySQLæ•°æ®åº“ä¸­
4. æ ¹æ®ä¸šåŠ¡é€»è¾‘ï¼ˆå¦‚æ¸©åº¦é˜ˆå€¼ï¼‰å‘è®¾å¤‡ä¸‹å‘æ§åˆ¶æŒ‡ä»¤
5. æä¾›å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œé‡è¿æœºåˆ¶

ä½œè€…: [æ‚¨çš„å§“å]
åˆ›å»ºæ—¶é—´: [åˆ›å»ºæ—¥æœŸ]
ç‰ˆæœ¬: 1.0
"""

# å¯¼å…¥å¿…è¦çš„åº“
import paho.mqtt.client as mqtt  # MQTTå®¢æˆ·ç«¯åº“ï¼Œç”¨äºä¸MQTTä»£ç†æœåŠ¡å™¨é€šä¿¡
import threading                 # çº¿ç¨‹åº“ï¼Œç”¨äºå¤šçº¿ç¨‹å¤„ç†ï¼ˆè™½ç„¶æœ¬ä¾‹ä¸­æœªç›´æ¥ä½¿ç”¨ï¼‰
import random                    # éšæœºæ•°åº“ï¼Œç”¨äºç”Ÿæˆå”¯ä¸€çš„å®¢æˆ·ç«¯ID
import time                      # æ—¶é—´åº“ï¼Œç”¨äºæ—¶é—´æˆ³å’Œå»¶æ—¶æ“ä½œ
import json                      # JSONåº“ï¼Œç”¨äºè§£æå’Œç”ŸæˆJSONæ ¼å¼çš„æ¶ˆæ¯
import mysql.connector           # MySQLè¿æ¥å™¨ï¼Œç”¨äºè¿æ¥å’Œæ“ä½œMySQLæ•°æ®åº“
from mysql.connector import Error  # MySQLé”™è¯¯å¤„ç†ç±»

# =============================================================================
# MQTTä»£ç†æœåŠ¡å™¨é…ç½®
# =============================================================================
MQTT_BROKER_IP = 'localhost'     # MQTTä»£ç†æœåŠ¡å™¨IPåœ°å€
                                 # å¦‚æœæ­¤è„šæœ¬å’ŒEMQXåœ¨åŒä¸€å°æœåŠ¡å™¨ä¸Šï¼Œä½¿ç”¨'localhost'
                                 # å¦‚æœåœ¨ä¸åŒæœåŠ¡å™¨ä¸Šï¼Œè¯·ä½¿ç”¨EMQXæœåŠ¡å™¨çš„å…¬ç½‘IPåœ°å€
MQTT_BROKER_PORT = 1883          # MQTTä»£ç†æœåŠ¡å™¨ç«¯å£ï¼Œæ ‡å‡†ç«¯å£ä¸º1883
MQTT_TIMEOUT = 60                # MQTTè¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰

# =============================================================================
# MQTTä¸»é¢˜é…ç½®
# =============================================================================
# æ•°æ®ä¸Šè¡Œä¸»é¢˜ï¼šSTM32ç­‰è®¾å¤‡å‘å¸ƒä¼ æ„Ÿå™¨æ•°æ®åˆ°æ­¤ä¸»é¢˜
DATA_TOPIC = "stm32/data"

# æŒ‡ä»¤ä¸‹è¡Œä¸»é¢˜æ ¼å¼ï¼šç½‘å…³å‘å¸ƒæ§åˆ¶æŒ‡ä»¤åˆ°æ­¤ä¸»é¢˜
# {client_id} æ˜¯å ä½ç¬¦ï¼Œä¼šè¢«å®é™…çš„è®¾å¤‡å®¢æˆ·ç«¯IDæ›¿æ¢
# ä¾‹å¦‚ï¼šstm32/command/device001
COMMAND_TOPIC_FORMAT = "stm32/command/{client_id}"

# =============================================================================
# MySQLæ•°æ®åº“é…ç½®
# =============================================================================
# !!! é‡è¦æç¤ºï¼šè¯·æ ¹æ®æ‚¨çš„å®é™…æ•°æ®åº“è®¾ç½®ä¿®æ”¹ä»¥ä¸‹é…ç½®ä¿¡æ¯ !!!
# MYSQL_CONFIGæ˜¯ä¸€ä¸ªå­—å…¸(dict)ç±»å‹ï¼Œç”¨äºå­˜å‚¨MySQLæ•°æ®åº“çš„è¿æ¥é…ç½®ä¿¡æ¯
MYSQL_CONFIG = {
    'host': 'localhost',         # MySQLæœåŠ¡å™¨åœ°å€
    'user': 'm2joy',            # æ•°æ®åº“ç”¨æˆ·å
    'password': 'Liu041121@',    # æ•°æ®åº“å¯†ç 
    'database': 'iot_data'       # æ•°æ®åº“åç§°
}


class MqttGateway:
    """
    MQTTç‰©è”ç½‘ç½‘å…³ç±»
    ================

    è¿™ä¸ªç±»å®ç°äº†ä¸€ä¸ªå®Œæ•´çš„MQTTç½‘å…³åŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š
    - è¿æ¥MQTTä»£ç†æœåŠ¡å™¨ï¼ˆå¦‚EMQXï¼‰
    - è®¢é˜…è®¾å¤‡æ•°æ®ä¸»é¢˜ï¼Œæ¥æ”¶æ¥è‡ªSTM32ç­‰è®¾å¤‡çš„ä¼ æ„Ÿå™¨æ•°æ®
    - å°†æ¥æ”¶åˆ°çš„æ•°æ®å­˜å‚¨åˆ°MySQLæ•°æ®åº“ä¸­
    - æ ¹æ®ä¸šåŠ¡é€»è¾‘ï¼ˆå¦‚æ¸©åº¦é˜ˆå€¼ï¼‰å‘è®¾å¤‡ä¸‹å‘æ§åˆ¶æŒ‡ä»¤
    - æä¾›å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œé‡è¿æœºåˆ¶

    ä¸»è¦åŠŸèƒ½æµç¨‹ï¼š
    1. åˆå§‹åŒ–æ—¶è‡ªåŠ¨è¿æ¥æ•°æ®åº“å¹¶åˆ›å»ºå¿…è¦çš„è¡¨
    2. å¯åŠ¨MQTTå®¢æˆ·ç«¯å¹¶è¿æ¥åˆ°ä»£ç†æœåŠ¡å™¨
    3. è®¢é˜…è®¾å¤‡æ•°æ®ä¸»é¢˜
    4. æ¥æ”¶å¹¶è§£æè®¾å¤‡å‘é€çš„JSONæ ¼å¼ä¼ æ„Ÿå™¨æ•°æ®
    5. å°†æ•°æ®å­˜å‚¨åˆ°MySQLæ•°æ®åº“
    6. æ ¹æ®æ¸©åº¦é˜ˆå€¼åˆ¤æ–­æ˜¯å¦éœ€è¦å‘é€æ§åˆ¶æŒ‡ä»¤
    """

    def __init__(self, broker_ip, port, timeout):
        """
        åˆå§‹åŒ–MQTTç½‘å…³

        å‚æ•°:
            broker_ip (str): MQTTä»£ç†æœåŠ¡å™¨çš„IPåœ°å€
            port (int): MQTTä»£ç†æœåŠ¡å™¨çš„ç«¯å£å·ï¼ˆé€šå¸¸ä¸º1883ï¼‰
            timeout (int): MQTTè¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰

        åŠŸèƒ½ï¼š
        1. ä¿å­˜è¿æ¥å‚æ•°
        2. åˆå§‹åŒ–è¿æ¥çŠ¶æ€æ ‡å¿—
        3. è®¾ç½®æ•°æ®åº“è¿æ¥å¹¶åˆ›å»ºå¿…è¦çš„è¡¨
        4. å¯åŠ¨MQTTå®¢æˆ·ç«¯è¿æ¥
        """
        # ä¿å­˜MQTTä»£ç†æœåŠ¡å™¨è¿æ¥å‚æ•°
        self.broker_ip = broker_ip      # MQTTä»£ç†æœåŠ¡å™¨IPåœ°å€
        self.broker_port = port         # MQTTä»£ç†æœåŠ¡å™¨ç«¯å£
        self.timeout = timeout          # è¿æ¥è¶…æ—¶æ—¶é—´

        # è¿æ¥çŠ¶æ€æ ‡å¿—ï¼Œç”¨äºè·Ÿè¸ªMQTTè¿æ¥çŠ¶æ€
        self.connected = False

        # MQTTå®¢æˆ·ç«¯å¯¹è±¡ï¼Œåˆå§‹åŒ–ä¸ºNone
        self.client = None

        # åˆå§‹åŒ–é£æ‰‡çŠ¶æ€å­—å…¸ï¼Œç”¨äºè·Ÿè¸ªæ¯ä¸ªè®¾å¤‡çš„é£æ‰‡çŠ¶æ€
        # Trueè¡¨ç¤ºé£æ‰‡å¼€å¯ï¼ŒFalseè¡¨ç¤ºé£æ‰‡å…³é—­
        self.fan_states = {}

        # åˆå§‹åŒ–æ•°æ®åº“è¿æ¥å¹¶åˆ›å»ºå¿…è¦çš„è¡¨
        # è¿™ä¸€æ­¥ä¼šè‡ªåŠ¨è¿æ¥åˆ°MySQLæ•°æ®åº“å¹¶åˆ›å»ºsensor_readingsè¡¨ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        self.db_conn = self.setup_database()

        # å¯åŠ¨MQTTå®¢æˆ·ç«¯å¹¶è¿æ¥åˆ°ä»£ç†æœåŠ¡å™¨
        # è¿™ä¸€æ­¥ä¼šåˆ›å»ºMQTTå®¢æˆ·ç«¯ã€è®¾ç½®å›è°ƒå‡½æ•°å¹¶å¼€å§‹è¿æ¥
        self.start_client()

    def setup_database(self):
        """
        è®¾ç½®å¹¶è¿æ¥åˆ°MySQLæ•°æ®åº“ï¼Œå¦‚æœè¡¨ä¸å­˜åœ¨åˆ™è‡ªåŠ¨åˆ›å»º

        è¿”å›å€¼:
            mysql.connector.connection: æ•°æ®åº“è¿æ¥å¯¹è±¡ï¼Œè¿æ¥å¤±è´¥æ—¶è¿”å›None

        åŠŸèƒ½ï¼š
        1. ä½¿ç”¨é¢„å®šä¹‰çš„é…ç½®ä¿¡æ¯è¿æ¥MySQLæ•°æ®åº“
        2. éªŒè¯è¿æ¥çŠ¶æ€
        3. åˆ›å»ºsensor_readingsè¡¨ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        4. å¤„ç†æ•°æ®åº“è¿æ¥å’Œæ“ä½œå¼‚å¸¸

        æ•°æ®è¡¨ç»“æ„ï¼š
        - id: è‡ªå¢ä¸»é”®
        - client_id: è®¾å¤‡å®¢æˆ·ç«¯IDï¼ˆæœ€å¤§255å­—ç¬¦ï¼‰
        - temperature: æ¸©åº¦å€¼ï¼ˆDECIMALç±»å‹ï¼Œ5ä½æ•°å­—ï¼Œ2ä½å°æ•°ï¼‰
        - timestamp: æ—¶é—´æˆ³ï¼ˆè‡ªåŠ¨è®¾ç½®ä¸ºå½“å‰æ—¶é—´ï¼‰
        """
        try:
            # ä½¿ç”¨é¢„å®šä¹‰çš„é…ç½®ä¿¡æ¯è¿æ¥MySQLæ•°æ®åº“
            # **MYSQL_CONFIG ä¼šå±•å¼€å­—å…¸ä¸­çš„æ‰€æœ‰é”®å€¼å¯¹ä½œä¸ºå‚æ•°
            conn = mysql.connector.connect(**MYSQL_CONFIG)

            # éªŒè¯æ•°æ®åº“è¿æ¥æ˜¯å¦æˆåŠŸå»ºç«‹
            if conn.is_connected():
                print("âœ… æˆåŠŸè¿æ¥åˆ°MySQLæ•°æ®åº“")

                # åˆ›å»ºæ•°æ®åº“æ¸¸æ ‡ï¼Œç”¨äºæ‰§è¡ŒSQLè¯­å¥
                cursor = conn.cursor()

                # åˆ›å»ºä¼ æ„Ÿå™¨æ•°æ®è¡¨ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
                # ä½¿ç”¨IF NOT EXISTSç¡®ä¿è¡¨åªåœ¨ä¸å­˜åœ¨æ—¶æ‰åˆ›å»º
                # æ³¨æ„ï¼šè¿™é‡Œçš„SQLæ ¼å¼åŒ–æ˜¯ä¸ºäº†æé«˜å¯è¯»æ€§
                cursor.execute('''
                    CREATE TABLE IF NOT EXISTS sensor_readings (
                        -- è‡ªå¢ä¸»é”®ï¼Œç”¨äºå”¯ä¸€æ ‡è¯†æ¯æ¡è®°å½•
                        id INT AUTO_INCREMENT PRIMARY KEY,
                        
                        -- è®¾å¤‡å®¢æˆ·ç«¯IDï¼Œç”¨äºæ ‡è¯†æ•°æ®æ¥æºè®¾å¤‡
                        -- VARCHAR(255)å…è®¸å­˜å‚¨æœ€å¤§255ä¸ªå­—ç¬¦çš„è®¾å¤‡æ ‡è¯†ç¬¦
                        client_id VARCHAR(255) NOT NULL,
                        
                        -- æ¸©åº¦ä¼ æ„Ÿå™¨è¯»æ•°ï¼Œä½¿ç”¨DECIMAL(5,2)å­˜å‚¨
                        -- 5è¡¨ç¤ºæ€»ä½æ•°ï¼Œ2è¡¨ç¤ºå°æ•°ä½æ•°ï¼ŒèŒƒå›´ï¼š-999.99åˆ°999.99
                        temperature DECIMAL(5,2) NOT NULL,
                        
                        -- æ•°æ®è®°å½•æ—¶é—´æˆ³ï¼Œé»˜è®¤ä¸ºå½“å‰æ—¶é—´
                        -- ä½¿ç”¨DATETIMEç±»å‹å­˜å‚¨å®Œæ•´çš„æ—¥æœŸå’Œæ—¶é—´ä¿¡æ¯
                        timestamp DATETIME DEFAULT CURRENT_TIMESTAMP
                    )
                ''')

                # æäº¤äº‹åŠ¡ï¼Œç¡®ä¿è¡¨åˆ›å»ºæ“ä½œæŒä¹…åŒ–
                conn.commit()

                # å…³é—­æ¸¸æ ‡é‡Šæ”¾èµ„æº
                cursor.close()

                print("ğŸ“‹ æ•°æ®è¡¨ 'sensor_readings' å·²å‡†å¤‡å°±ç»ª")
                return conn

        except Error as e:
            print(f"âŒ æ•°æ®åº“è¿æ¥æˆ–æ“ä½œå¤±è´¥: {e}")
            return None

    def start_client(self):
        """
        é…ç½®å¹¶å¯åŠ¨Paho MQTTå®¢æˆ·ç«¯

        åŠŸèƒ½ï¼š
        1. ç”Ÿæˆå”¯ä¸€çš„å®¢æˆ·ç«¯ID
        2. åˆ›å»ºMQTTå®¢æˆ·ç«¯å®ä¾‹
        3. è®¾ç½®äº‹ä»¶å›è°ƒå‡½æ•°
        4. è¿æ¥åˆ°MQTTä»£ç†æœåŠ¡å™¨
        5. å¯åŠ¨ç½‘ç»œå¾ªç¯å¤„ç†
        6. å¤„ç†è¿æ¥å¼‚å¸¸

        æ³¨æ„ï¼š
        - å®¢æˆ·ç«¯IDå¿…é¡»åœ¨MQTTä»£ç†æœåŠ¡å™¨ä¸­å”¯ä¸€
        - loop_start()ä¼šåœ¨åå°çº¿ç¨‹ä¸­å¤„ç†ç½‘ç»œé€šä¿¡
        - è¿æ¥æ˜¯å¼‚æ­¥çš„ï¼Œå®é™…è¿æ¥ç»“æœåœ¨on_connectå›è°ƒä¸­å¤„ç†
        """
        # ç”Ÿæˆå”¯ä¸€çš„å®¢æˆ·ç«¯IDï¼Œæ ¼å¼ï¼šmqtt_gateway_xxxx
        # ä½¿ç”¨éšæœºæ•°ç¡®ä¿æ¯æ¬¡è¿è¡Œæ—¶éƒ½æœ‰ä¸åŒçš„å®¢æˆ·ç«¯ID
        client_name = f"mqtt_gateway_{random.randint(1000, 9999)}"

        # åˆ›å»ºMQTTå®¢æˆ·ç«¯å®ä¾‹
        # mqtt.CallbackAPIVersion.VERSION1 æŒ‡å®šä½¿ç”¨ç‰ˆæœ¬1çš„å›è°ƒAPI
        self.client = mqtt.Client(mqtt.CallbackAPIVersion.VERSION2, client_name)

        # è®¾ç½®MQTTäº‹ä»¶å›è°ƒå‡½æ•°
        self.client.on_connect = self.on_connect    # è¿æ¥æˆåŠŸæ—¶çš„å›è°ƒ
        self.client.on_message = self.on_message    # æ¥æ”¶æ¶ˆæ¯æ—¶çš„å›è°ƒ

        try:
            print(f"ğŸ”„ æ­£åœ¨è¿æ¥MQTTä»£ç†æœåŠ¡å™¨ {self.broker_ip}:{self.broker_port}")
            
            # è¿æ¥åˆ°MQTTä»£ç†æœåŠ¡å™¨
            # å‚æ•°ï¼šIPåœ°å€ã€ç«¯å£ã€ä¿æŒè¿æ¥è¶…æ—¶æ—¶é—´
            self.client.connect(self.broker_ip, self.broker_port, self.timeout)

            # å¯åŠ¨ç½‘ç»œå¾ªç¯ï¼Œåœ¨åå°çº¿ç¨‹ä¸­å¤„ç†ç½‘ç»œé€šä¿¡
            # è¿™æ˜¯éé˜»å¡çš„ï¼Œå…è®¸ä¸»çº¿ç¨‹ç»§ç»­æ‰§è¡Œå…¶ä»–ä»»åŠ¡
            self.client.loop_start()

        except Exception as e:
            print(f"âŒ è¿æ¥MQTTä»£ç†æœåŠ¡å™¨å¤±è´¥: {e}")

    def on_connect(self, client, userdata, flags, rc, properties=None):
        """
        MQTTè¿æ¥æˆåŠŸæ—¶çš„å›è°ƒå‡½æ•°

        å‚æ•°:
            client: MQTTå®¢æˆ·ç«¯å®ä¾‹
            userdata: ç”¨æˆ·æ•°æ®ï¼ˆæœ¬ä¾‹ä¸­æœªä½¿ç”¨ï¼Œä½†ä¿ç•™ä»¥ç¬¦åˆå›è°ƒå‡½æ•°ç­¾åï¼‰
            flags: è¿æ¥æ ‡å¿—ï¼ˆæœ¬ä¾‹ä¸­æœªä½¿ç”¨ï¼Œä½†ä¿ç•™ä»¥ç¬¦åˆå›è°ƒå‡½æ•°ç­¾åï¼‰
            rc (int): è¿æ¥ç»“æœä»£ç 
                     0: è¿æ¥æˆåŠŸ
                     1: åè®®ç‰ˆæœ¬é”™è¯¯
                     2: å®¢æˆ·ç«¯IDæ— æ•ˆ
                     3: æœåŠ¡å™¨ä¸å¯ç”¨
                     4: ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯
                     5: æœªæˆæƒ

        åŠŸèƒ½ï¼š
        1. æ£€æŸ¥è¿æ¥ç»“æœä»£ç 
        2. è®¾ç½®è¿æ¥çŠ¶æ€æ ‡å¿—
        3. è®¢é˜…è®¾å¤‡æ•°æ®ä¸»é¢˜
        4. è¾“å‡ºè¿æ¥çŠ¶æ€ä¿¡æ¯

        æ³¨æ„ï¼š
        - åªæœ‰åœ¨è¿æ¥æˆåŠŸï¼ˆrc=0ï¼‰æ—¶æ‰ä¼šè®¢é˜…ä¸»é¢˜
        - è®¢é˜…ä½¿ç”¨é»˜è®¤çš„QoSçº§åˆ«0ï¼ˆæœ€å¤šä¸€æ¬¡ä¼ é€’ï¼‰
        """
        if rc == 0:
            print("âœ… æˆåŠŸè¿æ¥åˆ°MQTTä»£ç†æœåŠ¡å™¨!")

            # è®¾ç½®è¿æ¥çŠ¶æ€æ ‡å¿—ä¸ºTrue
            self.connected = True

            # è®¢é˜…è®¾å¤‡æ•°æ®ä¸»é¢˜
            # QoS=0è¡¨ç¤º"æœ€å¤šä¸€æ¬¡"ä¼ é€’ï¼Œæ¶ˆæ¯å¯èƒ½ä¸¢å¤±ä½†ä¸ä¼šé‡å¤
            client.subscribe(DATA_TOPIC)
            print(f"ğŸ“¡ å·²è®¢é˜…ä¸»é¢˜: {DATA_TOPIC}")
        else:
            print(f"âŒ è¿æ¥å¤±è´¥ï¼Œé”™è¯¯ä»£ç : {rc}")
            self.connected = False

    def on_message(self, client, userdata, msg):
        """
        æ¥æ”¶åˆ°MQTTæ¶ˆæ¯æ—¶çš„æ ¸å¿ƒå¤„ç†å‡½æ•°

        å‚æ•°:
            client: MQTTå®¢æˆ·ç«¯å®ä¾‹ï¼ˆæœ¬ä¾‹ä¸­æœªä½¿ç”¨ï¼Œä½†ä¿ç•™ä»¥ç¬¦åˆå›è°ƒå‡½æ•°ç­¾åï¼‰
            userdata: ç”¨æˆ·æ•°æ®ï¼ˆæœ¬ä¾‹ä¸­æœªä½¿ç”¨ï¼Œä½†ä¿ç•™ä»¥ç¬¦åˆå›è°ƒå‡½æ•°ç­¾åï¼‰
            msg: æ¥æ”¶åˆ°çš„æ¶ˆæ¯å¯¹è±¡ï¼ŒåŒ…å«ä»¥ä¸‹å±æ€§ï¼š
                 - topic: æ¶ˆæ¯ä¸»é¢˜
                 - payload: æ¶ˆæ¯è½½è·ï¼ˆå­—èŠ‚æ ¼å¼ï¼‰
                 - qos: æ¶ˆæ¯çš„QoSçº§åˆ«
                 - retain: æ˜¯å¦ä¸ºä¿ç•™æ¶ˆæ¯

        åŠŸèƒ½ï¼š
        1. è§£ç æ¶ˆæ¯è½½è·ï¼ˆä»å­—èŠ‚è½¬æ¢ä¸ºUTF-8å­—ç¬¦ä¸²ï¼‰
        2. è§£æJSONæ ¼å¼çš„ä¼ æ„Ÿå™¨æ•°æ®
        3. éªŒè¯æ•°æ®å®Œæ•´æ€§ï¼ˆæ£€æŸ¥å¿…éœ€å­—æ®µï¼‰
        4. å°†æ•°æ®ä¿å­˜åˆ°MySQLæ•°æ®åº“
        5. æ ¹æ®ä¸šåŠ¡é€»è¾‘åˆ¤æ–­æ˜¯å¦éœ€è¦å‘é€æ§åˆ¶æŒ‡ä»¤
        6. å¤„ç†å„ç§å¼‚å¸¸æƒ…å†µ

        é¢„æœŸçš„æ¶ˆæ¯æ ¼å¼ï¼ˆJSONï¼‰ï¼š
        {
            "client_id": "è®¾å¤‡å®¢æˆ·ç«¯ID",
            "temperature": æ¸©åº¦å€¼ï¼ˆæ•°å­—ï¼‰
        }

        ä¸šåŠ¡é€»è¾‘ï¼š
        - å½“æ¸©åº¦è¶…è¿‡30Â°Cæ—¶ï¼Œå‘è®¾å¤‡å‘é€"open_fan"æŒ‡ä»¤
        - å½“æ¸©åº¦ä½äº25Â°Cæ—¶ï¼Œå‘è®¾å¤‡å‘é€"close_fan"æŒ‡ä»¤
        - ä½¿ç”¨fan_stateså­—å…¸è·Ÿè¸ªæ¯ä¸ªè®¾å¤‡çš„é£æ‰‡çŠ¶æ€ï¼Œé¿å…é‡å¤å‘é€ç›¸åŒæŒ‡ä»¤
        """
        try:
            # å°†æ¶ˆæ¯è½½è·ä»å­—èŠ‚æ ¼å¼è§£ç ä¸ºUTF-8å­—ç¬¦ä¸²
            payload_str = msg.payload.decode('utf-8')
            print(f"ğŸ“¨ æ”¶åˆ°æ¥è‡ªä¸»é¢˜ '{msg.topic}' çš„æ¶ˆæ¯: {payload_str}")

            # è§£æJSONæ ¼å¼çš„æ¶ˆæ¯æ•°æ®
            data = json.loads(payload_str)

            # æå–å…³é”®æ•°æ®å­—æ®µ
            client_id = data.get('client_id')      # è®¾å¤‡å®¢æˆ·ç«¯ID
            temperature = data.get('temperature')  # æ¸©åº¦å€¼

            # éªŒè¯æ•°æ®å®Œæ•´æ€§ - æ£€æŸ¥å¿…éœ€å­—æ®µæ˜¯å¦å­˜åœ¨
            if client_id is None or temperature is None:
                print("âš ï¸  è­¦å‘Š: æ¥æ”¶åˆ°çš„æ•°æ®ç¼ºå°‘ 'client_id' æˆ– 'temperature' å­—æ®µ")
                return

            # å°†ä¼ æ„Ÿå™¨æ•°æ®ä¿å­˜åˆ°æ•°æ®åº“
            self.save_to_db(client_id, temperature)

            # è·å–å½“å‰è®¾å¤‡çš„é£æ‰‡çŠ¶æ€ï¼ˆå¦‚æœä¸å­˜åœ¨åˆ™é»˜è®¤ä¸ºFalseï¼Œè¡¨ç¤ºé£æ‰‡å…³é—­ï¼‰
            current_fan_state = self.fan_states.get(client_id, False)

            # ä¸šåŠ¡é€»è¾‘ï¼šæ¸©åº¦é˜ˆå€¼æ£€æŸ¥
            if float(temperature) > 30.0 and not current_fan_state:
                print(f"ğŸš¨ è­¦æŠ¥: è®¾å¤‡ {client_id} çš„æ¸©åº¦ ({temperature}Â°C) è¶…è¿‡é˜ˆå€¼!")
                self.publish_command(client_id, "open_fan")
                self.fan_states[client_id] = True  # æ›´æ–°é£æ‰‡çŠ¶æ€ä¸ºå¼€å¯
            elif float(temperature) < 25.0 and current_fan_state:
                print(f"â„¹ï¸ æç¤º: è®¾å¤‡ {client_id} çš„æ¸©åº¦ ({temperature}Â°C) ä½äºé˜ˆå€¼ï¼Œå…³é—­é£æ‰‡")
                self.publish_command(client_id, "close_fan")
                self.fan_states[client_id] = False  # æ›´æ–°é£æ‰‡çŠ¶æ€ä¸ºå…³é—­

        except json.JSONDecodeError:
            # JSONè§£æå¤±è´¥çš„å¼‚å¸¸å¤„ç†
            print(f"âŒ JSONè§£æå¤±è´¥ï¼Œæ— æ•ˆçš„è½½è·æ ¼å¼: {msg.payload}")
        except Exception as e:
            # å…¶ä»–å¼‚å¸¸çš„é€šç”¨å¤„ç†
            print(f"âŒ å¤„ç†æ¶ˆæ¯æ—¶å‘ç”Ÿé”™è¯¯: {e}")

    def save_to_db(self, client_id, temperature):
        """
        å°†ä¼ æ„Ÿå™¨æ•°æ®ä¿å­˜åˆ°MySQLæ•°æ®åº“

        å‚æ•°:
            client_id (str): è®¾å¤‡å®¢æˆ·ç«¯ID
            temperature (float): æ¸©åº¦å€¼

        åŠŸèƒ½ï¼š
        1. æ£€æŸ¥æ•°æ®åº“è¿æ¥çŠ¶æ€
        2. å¦‚æœè¿æ¥æ–­å¼€ï¼Œå°è¯•é‡æ–°è¿æ¥
        3. æ‰§è¡ŒSQLæ’å…¥æ“ä½œ
        4. æäº¤äº‹åŠ¡ç¡®ä¿æ•°æ®æŒä¹…åŒ–
        5. å¤„ç†æ•°æ®åº“æ“ä½œå¼‚å¸¸
        6. åœ¨å‘ç”Ÿé”™è¯¯æ—¶å°è¯•é‡æ–°è¿æ¥æ•°æ®åº“

        æ•°æ®åº“æ“ä½œè¯´æ˜ï¼š
        - ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢é˜²æ­¢SQLæ³¨å…¥æ”»å‡»
        - timestampå­—æ®µä¼šè‡ªåŠ¨è®¾ç½®ä¸ºå½“å‰æ—¶é—´ï¼ˆæ•°æ®åº“é»˜è®¤å€¼ï¼‰
        - ä½¿ç”¨äº‹åŠ¡ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
        """
        # æ£€æŸ¥æ•°æ®åº“è¿æ¥çŠ¶æ€
        if self.db_conn is None or not self.db_conn.is_connected():
            print("ğŸ”„ æ•°æ®åº“è¿æ¥å·²æ–­å¼€ï¼Œå°è¯•é‡æ–°è¿æ¥...")

            # å°è¯•é‡æ–°å»ºç«‹æ•°æ®åº“è¿æ¥
            self.db_conn = self.setup_database()

            # å¦‚æœé‡è¿å¤±è´¥ï¼Œæ”¾å¼ƒä¿å­˜æ“ä½œ
            if self.db_conn is None:
                print("âŒ æ•°æ®åº“é‡è¿å¤±è´¥ï¼Œæ•°æ®æœªä¿å­˜")
                return

        try:
            # åˆ›å»ºæ•°æ®åº“æ¸¸æ ‡
            cursor = self.db_conn.cursor()

            # å®šä¹‰SQLæ’å…¥è¯­å¥
            # æ³¨æ„ï¼šMySQL-connectorä½¿ç”¨%sä½œä¸ºå‚æ•°å ä½ç¬¦ï¼ˆä¸æ˜¯%dæˆ–%fï¼‰
            # timestampå­—æ®µä½¿ç”¨æ•°æ®åº“é»˜è®¤å€¼ï¼ˆCURRENT_TIMESTAMPï¼‰
            sql = "INSERT INTO sensor_readings (client_id, temperature) VALUES (%s, %s)"
            val = (client_id, temperature)

            # æ‰§è¡ŒSQLè¯­å¥
            cursor.execute(sql, val)

            # æäº¤äº‹åŠ¡ï¼Œç¡®ä¿æ•°æ®æŒä¹…åŒ–åˆ°æ•°æ®åº“
            self.db_conn.commit()

            print(f"ğŸ’¾ æ•°æ®å·²ä¿å­˜åˆ°æ•°æ®åº“: è®¾å¤‡ID={client_id}, æ¸©åº¦={temperature}Â°C")

            # å…³é—­æ¸¸æ ‡é‡Šæ”¾èµ„æº
            cursor.close()

        except Error as e:
            print(f"âŒ æ•°æ®åº“æ’å…¥æ“ä½œå¤±è´¥: {e}")

            # å‘ç”Ÿé”™è¯¯æ—¶å…³é—­å½“å‰è¿æ¥å¹¶å°è¯•é‡æ–°è¿æ¥
            # è¿™æœ‰åŠ©äºå¤„ç†æ•°æ®åº“è¿æ¥è¶…æ—¶ç­‰é—®é¢˜
            try:
                self.db_conn.close()
            except:
                pass  # å¿½ç•¥å…³é—­è¿æ¥æ—¶çš„å¼‚å¸¸

            # å°è¯•é‡æ–°å»ºç«‹æ•°æ®åº“è¿æ¥ï¼Œä¸ºä¸‹æ¬¡æ“ä½œåšå‡†å¤‡
            self.db_conn = self.setup_database()

    def publish_command(self, client_id, command):
        """
        å‘æŒ‡å®šè®¾å¤‡å‘å¸ƒæ§åˆ¶æŒ‡ä»¤

        å‚æ•°:
            client_id (str): ç›®æ ‡è®¾å¤‡çš„å®¢æˆ·ç«¯ID
            command (str): è¦å‘é€çš„æ§åˆ¶æŒ‡ä»¤ï¼ˆå¦‚"open_fan", "close_fan"ç­‰ï¼‰

        åŠŸèƒ½ï¼š
        1. æ ¹æ®è®¾å¤‡IDæ„é€ ä¸“ç”¨çš„æŒ‡ä»¤ä¸»é¢˜
        2. åˆ›å»ºåŒ…å«æŒ‡ä»¤å’Œæ—¶é—´æˆ³çš„JSONè½½è·
        3. ä½¿ç”¨QoS=1çº§åˆ«å‘å¸ƒæŒ‡ä»¤æ¶ˆæ¯
        4. æ£€æŸ¥å‘å¸ƒç»“æœå¹¶è¾“å‡ºçŠ¶æ€ä¿¡æ¯

        ä¸»é¢˜æ ¼å¼ï¼š
        - ä½¿ç”¨COMMAND_TOPIC_FORMATæ¨¡æ¿
        - ä¾‹å¦‚ï¼šstm32/command/device001

        æ¶ˆæ¯æ ¼å¼ï¼ˆJSONï¼‰ï¼š
        {
            "command": "æŒ‡ä»¤åç§°",
            "timestamp": Unixæ—¶é—´æˆ³
        }

        QoSçº§åˆ«è¯´æ˜ï¼š
        - QoS=1: "è‡³å°‘ä¸€æ¬¡"ä¼ é€’ï¼Œç¡®ä¿æ¶ˆæ¯åˆ°è¾¾ä½†å¯èƒ½é‡å¤
        - é€‚ç”¨äºé‡è¦çš„æ§åˆ¶æŒ‡ä»¤ï¼Œç¡®ä¿è®¾å¤‡èƒ½æ”¶åˆ°
        """
        # æ ¹æ®è®¾å¤‡å®¢æˆ·ç«¯IDæ„é€ æŒ‡ä»¤ä¸»é¢˜
        # ä¾‹å¦‚ï¼šstm32/command/device001
        command_topic = COMMAND_TOPIC_FORMAT.format(client_id=client_id)

        # åˆ›å»ºJSONæ ¼å¼çš„æŒ‡ä»¤è½½è·
        command_payload = json.dumps({
            "command": command,                    # æ§åˆ¶æŒ‡ä»¤
            "timestamp": time.time()              # Unixæ—¶é—´æˆ³ï¼Œç”¨äºæŒ‡ä»¤å»é‡å’Œè¶…æ—¶æ£€æŸ¥
        })

        # å‘å¸ƒæŒ‡ä»¤æ¶ˆæ¯åˆ°æŒ‡å®šä¸»é¢˜
        # qos=1 ç¡®ä¿æ¶ˆæ¯è‡³å°‘ä¼ é€’ä¸€æ¬¡ï¼Œæé«˜æŒ‡ä»¤ä¼ é€’çš„å¯é æ€§
        result = self.client.publish(command_topic, command_payload, qos=1)

        # æ£€æŸ¥å‘å¸ƒç»“æœ
        if result.rc == mqtt.MQTT_ERR_SUCCESS:
            print(f"ğŸ“¤ æˆåŠŸå‘é€æŒ‡ä»¤ '{command}' åˆ°ä¸»é¢˜ '{command_topic}'")
        else:
            print(f"âŒ æŒ‡ä»¤å‘é€å¤±è´¥ï¼Œé”™è¯¯ä»£ç : {result.rc}")


# =============================================================================
# ä¸»ç¨‹åºå…¥å£
# =============================================================================
if __name__ == '__main__':
    """
    ä¸»ç¨‹åºå…¥å£ç‚¹

    åŠŸèƒ½ï¼š
    1. åˆ›å»ºMQTTç½‘å…³å®ä¾‹å¹¶å¯åŠ¨æœåŠ¡
    2. ä¿æŒç¨‹åºè¿è¡Œï¼Œç­‰å¾…MQTTæ¶ˆæ¯
    3. å¤„ç†ç”¨æˆ·ä¸­æ–­ä¿¡å·ï¼ˆCtrl+Cï¼‰
    4. ä¼˜é›…åœ°å…³é—­æ‰€æœ‰è¿æ¥å’Œèµ„æº

    è¿è¡Œæµç¨‹ï¼š
    1. ä½¿ç”¨é¢„å®šä¹‰çš„é…ç½®å‚æ•°åˆ›å»ºç½‘å…³å®ä¾‹
    2. è¿›å…¥æ— é™å¾ªç¯ï¼Œä¿æŒç¨‹åºè¿è¡Œ
    3. å½“ç”¨æˆ·æŒ‰Ctrl+Cæ—¶ï¼Œæ•è·KeyboardInterruptå¼‚å¸¸
    4. æ‰§è¡Œæ¸…ç†æ“ä½œï¼šåœæ­¢MQTTå¾ªç¯ã€å…³é—­æ•°æ®åº“è¿æ¥
    5. è¾“å‡ºå…³é—­çŠ¶æ€ä¿¡æ¯å¹¶é€€å‡ºç¨‹åº
    """
    print("ğŸš€ å¯åŠ¨MQTTç‰©è”ç½‘ç½‘å…³æœåŠ¡...")
    print(f"ğŸ“¡ MQTTä»£ç†æœåŠ¡å™¨: {MQTT_BROKER_IP}:{MQTT_BROKER_PORT}")
    print(f"ğŸ—„ï¸  æ•°æ®åº“: {MYSQL_CONFIG['host']}/{MYSQL_CONFIG['database']}")
    print("æŒ‰ Ctrl+C åœæ­¢æœåŠ¡\n")

    # åˆ›å»ºMQTTç½‘å…³å®ä¾‹
    # è¿™ä¼šè‡ªåŠ¨è¿æ¥æ•°æ®åº“ã€åˆ›å»ºè¡¨ã€è¿æ¥MQTTä»£ç†æœåŠ¡å™¨å¹¶è®¢é˜…ä¸»é¢˜
    gateway = MqttGateway(MQTT_BROKER_IP, MQTT_BROKER_PORT, MQTT_TIMEOUT)

    try:
        # ä¸»å¾ªç¯ï¼šä¿æŒç¨‹åºè¿è¡Œ
        # å®é™…çš„MQTTæ¶ˆæ¯å¤„ç†åœ¨åå°çº¿ç¨‹ä¸­è¿›è¡Œ
        while True:
            time.sleep(1)  # æ¯ç§’æ£€æŸ¥ä¸€æ¬¡ï¼Œé¿å…CPUå ç”¨è¿‡é«˜

    except KeyboardInterrupt:
        # æ•è·ç”¨æˆ·ä¸­æ–­ä¿¡å·ï¼ˆCtrl+Cï¼‰ï¼Œæ‰§è¡Œä¼˜é›…å…³é—­
        print("\nğŸ›‘ æ¥æ”¶åˆ°åœæ­¢ä¿¡å·ï¼Œæ­£åœ¨å…³é—­ç½‘å…³æœåŠ¡...")

        # åœæ­¢MQTTå®¢æˆ·ç«¯çš„ç½‘ç»œå¾ªç¯
        if gateway.client:
            gateway.client.loop_stop()
            print("ğŸ“¡ MQTTå®¢æˆ·ç«¯å·²åœæ­¢")

        # å…³é—­æ•°æ®åº“è¿æ¥
        if gateway.db_conn and gateway.db_conn.is_connected():
            gateway.db_conn.close()
            print("ğŸ—„ï¸  MySQLæ•°æ®åº“è¿æ¥å·²å…³é—­")

        print("âœ… ç½‘å…³æœåŠ¡å·²å®‰å…¨å…³é—­")
